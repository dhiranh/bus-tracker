<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morning Dashboard</title>
    <style>
        :root { 
            --tfl-red: #dc241f; 
            --bg: #000000; 
            --card: #151515; 
            --gold: #ffcc00; 
            --text-dim: #777; 
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: white; 
            margin: 0; 
            padding: 8px; 
            overflow: hidden; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Weather Bar */
        .weather-bar { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: var(--card); 
            border-radius: 12px; 
            padding: 0 15px; 
            margin-bottom: 8px; 
            border: 1px solid #222;
            height: 60px;
            flex-shrink: 0;
        }
        .temp-display { font-size: 1.8rem; font-weight: 800; }
        .weather-info { display: flex; align-items: center; }
        .weather-desc { 
            font-size: 0.8rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            color: var(--text-dim); 
            margin-right: 8px; 
        }
        .weather-icon { width: 48px; height: 48px; }

        /* Bus Card Section */
        .bus-card { 
            background: var(--card); 
            border-radius: 14px; 
            margin-bottom: 8px; 
            padding: 10px 15px; 
            display: flex; 
            align-items: center; 
            border-left: 10px solid var(--tfl-red);
            flex-grow: 1;
            max-height: 100px;
        }
        .bus-main { flex-grow: 1; overflow: hidden; }
        .bus-line { font-size: 2.2rem; font-weight: 900; line-height: 1; margin-bottom: 2px; }
        .bus-dest { 
            font-size: 0.85rem; 
            color: var(--text-dim); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 140px; 
            font-weight: 500;
        }

        /* Timings Section */
        .timings { text-align: right; }
        .arrival-container { 
            display: flex; 
            align-items: baseline; 
            justify-content: flex-end; 
            line-height: 1;
            min-height: 3.2rem;
        }
        .arrival-num { font-weight: 900; color: white; transition: font-size 0.2s ease; }
        .min-label { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: var(--text-dim); 
            margin-left: 6px; 
        }
        
        .leave-box { 
            border-top: 1px solid #333; 
            margin-top: 5px; 
            padding-top: 3px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
        }
        .leave-label { 
            font-size: 0.55rem; 
            color: var(--gold); 
            text-transform: uppercase; 
            font-weight: bold; 
            letter-spacing: 0.5px; 
        }
        .leave-countdown { 
            font-size: 1.4rem; 
            font-weight: 800; 
            color: var(--gold); 
            font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, monospace; 
        }
    </style>
</head>
<body>

    <div class="weather-bar">
        <div class="temp-display">{{ weather.temp }}Â°C</div>
        <div class="weather-info">
            <span class="weather-desc">{{ weather.desc }}</span>
            <img src="{{ weather.icon }}" class="weather-icon" alt="weather">
        </div>
    </div>

    {% for bus in buses %}
    <div class="bus-card">
        <div class="bus-main">
            <div class="bus-line">{{ bus.line }}</div>
            <div class="bus-dest">{{ bus.dest }}</div>
        </div>
        <div class="timings">
            <div class="arrival-container">
                <span class="arrival-num" data-arrival="{{ bus.arrival_ts }}">--</span>
                <span class="min-label">min</span>
            </div>
            <div class="leave-box">
                <span class="leave-label">Leave In</span>
                <span class="leave-countdown" data-leave="{{ bus.leave_ts }}">--:--</span>
            </div>
        </div>
    </div>
    {% endfor %}

    <script>
        function updateDisplay() {
            const now = Date.now();
            document.querySelectorAll('.bus-card').forEach(card => {
                const arrivalTs = parseInt(card.querySelector('.arrival-num').getAttribute('data-arrival'));
                const leaveTs = parseInt(card.querySelector('.leave-countdown').getAttribute('data-leave'));
                const label = card.querySelector('.min-label');
                const numEl = card.querySelector('.arrival-num');
                
                // 1. Arrival Minutes Logic
                const diffArrival = Math.floor((arrivalTs - now) / 60000);
                
                if (diffArrival <= 0) {
                    numEl.innerText = "DUE";
                    numEl.style.fontSize = "2.4rem"; // Balanced size for "DUE" text
                    numEl.style.letterSpacing = "1px";
                    label.style.display = "none";
                } else {
                    numEl.innerText = diffArrival;
                    numEl.style.fontSize = "3.2rem"; // Larger size for numbers
                    numEl.style.letterSpacing = "normal";
                    label.style.display = "inline-block";
                    label.innerText = "min";
                }

                // 2. Ticking Leave Countdown Logic
                const diffLeave = leaveTs - now;
                const leaveEl = card.querySelector('.leave-countdown');
                
                if (diffLeave <= 0) {
                    leaveEl.innerText = "NOW";
                    leaveEl.style.color = "#ff453a"; // Red alert for "NOW"
                } else {
                    const totalSecs = Math.floor(diffLeave / 1000);
                    const m = Math.floor(totalSecs / 60);
                    const s = totalSecs % 60;
                    leaveEl.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                    leaveEl.style.color = "var(--gold)";
                }
            });
        }

        // Ticking engine (every 1 second)
        setInterval(updateDisplay, 1000);
        updateDisplay();

        // Data refresh (every 30 seconds)
        setTimeout(() => {
            location.reload();
        }, 30000);
    </script>
</body>
</html>