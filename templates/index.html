<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morning Dashboard</title>
    <style>
        :root { 
            --tfl-red: #dc241f; 
            --bg: #000000; 
            --card: #151515; 
            --text-main: #ffffff;
            --text-dim: #aaa; 
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            padding: 10px; 
            overflow: hidden; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* Symmetrical Weather Bar */
        .weather-bar { 
            display: flex; 
            flex: 1;
            align-items: center; 
            background: var(--card); 
            border-radius: 16px; 
            margin-bottom: 10px; 
            border: 2px solid #222;
            border-left: 15px solid transparent; 
            min-height: 0;
            padding: 0;
        }

        .temp-display { 
            width: 50%; 
            font-size: 5.5rem; 
            font-weight: 900; 
            letter-spacing: -3px; 
            padding-left: 15px;
            box-sizing: border-box;
        }

        .weather-info { 
            width: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            padding-right: 0px;
            box-sizing: border-box;
        }

        .weather-icon { width: 130px; height: 130px; } 

        .bus-card { 
            background: var(--card); 
            border-radius: 16px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            border-left: 15px solid var(--tfl-red);
            flex: 1; 
            min-height: 0; 
            padding: 0; 
        }
        
        .bus-main { 
            width: 50%; 
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-left: 15px;
            overflow: hidden;
            box-sizing: border-box;
        }
        .bus-line { font-size: 4.8rem; font-weight: 900; line-height: 0.8; margin-bottom: 8px; letter-spacing: -2px; }
        
        .dest-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stop-badge {
            background: var(--tfl-red);
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            line-height: 1;
        }

        .bus-dest { 
            font-size: 1.1rem; 
            color: var(--text-dim); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-weight: 800;
            text-transform: uppercase;
        }

        .timings { 
            width: 50%; 
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: right; 
            padding-right: 15px;
            box-sizing: border-box;
        }
        
        .arrival-container { 
            display: flex; 
            align-items: baseline; 
            justify-content: flex-end; 
            line-height: 0.8;
        }
        .arrival-num { font-weight: 900; color: white; }
        .min-label { 
            font-size: 1.5rem; 
            font-weight: 800; 
            color: var(--text-dim); 
            margin-left: 5px; 
        }
        
        .leave-box { 
            border-top: 2px solid #333; 
            margin-top: 8px; 
            padding-top: 5px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
        }
        .leave-label { 
            font-size: 0.9rem; 
            color: var(--tfl-red); 
            text-transform: uppercase; 
            font-weight: 900; 
            letter-spacing: 1px; 
        }
        .leave-countdown { 
            font-size: 2.5rem; 
            font-weight: 900; 
            color: var(--text-main); /* Changed to White */
            font-family: ui-monospace, 'Cascadia Code', monospace; 
            line-height: 1;
        }

        .bus-card:last-child { margin-bottom: 0; }
    </style>
</head>
<body>

    <div class="weather-bar">
        <div class="temp-display">{{ weather.temp }}Â°</div>
        <div class="weather-info">
            <img src="{{ weather.icon }}" class="weather-icon" alt="weather">
        </div>
    </div>

    {% for bus in buses[:4] %}
    <div class="bus-card">
        <div class="bus-main">
            <div class="bus-line">{{ bus.line }}</div>
            <div class="dest-container">
                {% if bus.stop_letter %}
                <div class="stop-badge">{{ bus.stop_letter }}</div>
                {% endif %}
                <div class="bus-dest">{{ bus.dest }}</div>
            </div>
        </div>
        <div class="timings">
            <div class="arrival-container">
                <span class="arrival-num" data-arrival="{{ bus.arrival_ts }}">--</span>
                <span class="min-label">min</span>
            </div>
            <div class="leave-box">
                <span class="leave-label">Leave In</span>
                <span class="leave-countdown" data-leave="{{ bus.leave_ts }}">--:--</span>
            </div>
        </div>
    </div>
    {% endfor %}

    <script>
        function updateDisplay() {
            const now = Date.now();
            document.querySelectorAll('.bus-card').forEach(card => {
                const arrivalTs = parseInt(card.querySelector('.arrival-num').getAttribute('data-arrival'));
                const leaveTs = parseInt(card.querySelector('.leave-countdown').getAttribute('data-leave'));
                const label = card.querySelector('.min-label');
                const numEl = card.querySelector('.arrival-num');
                
                const diffArrival = Math.floor((arrivalTs - now) / 60000);
                
                if (diffArrival <= 0) {
                    numEl.innerText = "DUE";
                    numEl.style.fontSize = "3.5rem"; 
                    numEl.style.color = "var(--tfl-red)"; /* Highlights when it's due */
                    label.style.display = "none";
                } else {
                    numEl.innerText = diffArrival;
                    numEl.style.fontSize = "5rem"; 
                    numEl.style.color = "white";
                    label.style.display = "inline-block";
                }

                const diffLeave = leaveTs - now;
                const leaveEl = card.querySelector('.leave-countdown');
                
                if (diffLeave <= 0) {
                    leaveEl.innerText = "NOW";
                    leaveEl.style.color = "var(--tfl-red)"; 
                } else {
                    const totalSecs = Math.floor(diffLeave / 1000);
                    const m = Math.floor(totalSecs / 60);
                    const s = totalSecs % 60;
                    leaveEl.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                    leaveEl.style.color = "white";
                }
            });
        }

        setInterval(updateDisplay, 1000);
        updateDisplay();
        setTimeout(() => { location.reload(); }, 30000);
    </script>
</body>
</html>